<!DOCTYPE html>
<html>

<head>
    <title>Text Transforms</title>
    <link rel="stylesheet" href="css/textdemo.css">
    <script src="js/scrollx.js" type="text/javascript"></script>
    <script src="js/json_module.js" type="text/javascript"></script>
    <script src="js/xsl_module.js" type="text/javascript"></script>
    <script src="js/svg_module.js" type="text/javascript"></script>
    <script src="js/dependencies/d3.v3.min.js" type="text/javascript"></script>
    <script src="js/dependencies/graphlib-dot.min.js" type="text/javascript"></script>
    <script src="js/dependencies/dagre.min.js" type="text/javascript"></script>
    <script src="js/dependencies/dagre-d3.min.js" type="text/javascript"></script>
    <script type="text/javascript">

        // Module/name space TextTransformers
        var TextTransformers = TextTransformers || {
          JsonToHtmlTransformer: function() {
            this.transform = function( json ) {
              var html = '';
              json.sequences[0].canvases[0].resources.forEach( function( item ) {
                if( item.resource['@type'] == 'cnt:ContentAsText' ) {
                  html += '<p>' + item.resource['cnt:chars'] + '</p>'
                }
              } );
              return html;
            }
          },
          JsonToTeiTransformer: function() {
            this.transform = function( json_string ) {
              var json = JSON.parse( json_string );
              var columns = [];
              var x_val = 0;
              json.sequences[0].canvases[0].resources.forEach( function( item ) {
                if( item.resource['@type'] == 'cnt:ContentAsText' ) {
                  if( x_val < parseInt( item.on.match( /^.*#xywh=-?(\d+)/ )[1] ) ) {
                    columns.push( [] );
                    x_val = parseInt( item.on.match( /^.*#xywh=-?(\d+)/ )[1] )
                  };
                  var lineid = item['@id'].match( /^.*line\/(\d+)$/ )[1];
                  columns[ columns.length - 1 ].push( [ lineid, item.resource['cnt:chars'] ] );
                }
              } );
              var xmlstring = '';
              columns.forEach( function( column, cn ) {
                xmlstring += '<cb n="' + ( cn + 1 ) + '"/>\n';
                column.forEach( function( line, ln ) {
                  xmlstring += '<lb xml:id="l' + line[0] + '" n="' + ( ln  + 1 ) + '"/>' + line[1] + '\n';
                } );
              } );
              var stylesheet_decl = '<?xml-stylesheet type="text/xsl" href="resources/tei_demo_doc.xsl"?>';
              var frontmatter = '<TEI version="5.0" xmlns="http://www.tei-c.org/ns/1.0"><teiHeader><fileDesc><titleStmt><title>DocTitle</title></titleStmt><publicationStmt><p>This is a publication statement</p></publicationStmt><sourceDesc><p>Source description</p></sourceDesc></fileDesc></teiHeader><text>';
              var backmatter = '</text></TEI>';
              var xmlDoc = stylesheet_decl + '\n' + frontmatter+ '<body><ab>' + xmlstring + '</ab></body>' + backmatter;
              return xmlDoc;
            }
          },
          TeiToHTMLTransformer: function() {
            this.transform = function( tei, callback ) {
              var xsl = new XSL_MODULE();
              xsl.getXSL( function( stylesheet ) {
                var xsltProcessor = new XSLTProcessor();
                xsltProcessor.importStylesheet( stylesheet );
                var parser = new DOMParser();
                var xml_doc = parser.parseFromString( tei, "text/xml" );
                var result_document = xsltProcessor.transformToFragment( xml_doc, document );
                var serializer = new XMLSerializer();
                var result_document_as_string = serializer.serializeToString( result_document );
                callback( result_document_as_string );
              } );
            }
          },
          HtmlToXmlTransformer: function() {
            this.transform = function( html ) {
              var xml = html.replace( /\<p[^\>]*\>/, '<par>' );
              xml = xml.replace( /\<\/p\>/, '</par>' );
              xml = xml.replace( /\<b\>/, '</emph>' );
              xml = xml.replace( /\<\/b\>/, '</emph>' );
              return xml;
            }
          },
          TeiToDotTransformer: function() {
            this.transform = function( tei ) {
              return "not implemented yet!"
            }
          },
          set_textarea_content: function( textarea_id, content ) {
            var textarea = gEBI( textarea_id );
            textarea.value = content;
          },
          set_iframe_content: function( iframe_id, content ) {
            var iframe = gEBI( iframe_id );
            iframe.contentWindow.document.open();
            iframe.contentWindow.document.write( content );
            iframe.contentWindow.document.close();
          }
        }

        // Code in global name space
        gEBI = function( id ) { return document.getElementById( id ) };

        window.onload = function() {
          // Next will not work with IE, but I don't care about IE.
          if( self==top ){ gEBI( 'demo_panels' ).style.height = ( Math.floor( window.innerHeight * 0.97) ).toString() + 'px' };
          var json = new JSON_MODULE();
          json.getExampleJSON( function( json_data ) {
            TextTransformers.set_textarea_content( 'json', JSON.stringify( json_data ) );
            var transformer = new TextTransformers.JsonToHtmlTransformer();
            TextTransformers.set_iframe_content( 'iframe_json', transformer.transform( json_data ) );
          } );
          gEBI( 'to_tei' ).addEventListener( 'click', function() {
            var left_x = gEBI( 'demo_panel_002' ).offsetLeft;
            scrollToX( left_x, 500, 'easeInOutQuint' );
            var transformer = new TextTransformers.JsonToTeiTransformer();
            gEBI( 'tei' ).value = transformer.transform( gEBI( 'json' ).value );
            transformer = new TextTransformers.TeiToHTMLTransformer();
            transformer.transform( gEBI( 'tei' ).value, function( tei_as_html ) {
              TextTransformers.set_iframe_content( 'iframe_tei', tei_as_html );
            } );
          } );
          gEBI( 'to_dot' ).addEventListener( 'click', function() {
            var left_x = gEBI( 'demo_panel_003' ).offsetLeft;
            scrollToX( left_x, 500, 'easeInOutQuint' );
            var transformer = new TextTransformers.TeiToDotTransformer();
            gEBI( 'dot' ).value = transformer.transform( gEBI( 'tei' ).value );
            var svg_renderer = new SVG_MODULE();
            svg_renderer.render_dot( gEBI( 'dot' ).value, '#svg_graph g' );
          } );
          gEBI( 'back_to_tei' ).addEventListener( 'click', function() {
            var left_x = gEBI( 'demo_panel_002' ).offsetLeft;
            scrollToX( left_x, 500, 'easeInOutQuint' );
          } );
        };
    </script>
</head>
<body>
    <div id="demo_panels">
      <div id="demo_panel_001" class="demo_panel">
        <p>.txt -&gt; HTML -&gt; Shared Canvas JSON -&gt; TEI -&gt; Graph -&gt; HTML</p>
        <textarea id="json"></textarea>
        <iframe id="iframe_json"></iframe>
        <div id="to_tei" class="button">json to tei</div>
      </div>
      <div id="demo_panel_002" class="demo_panel">
        <textarea id="tei"></textarea>
        <iframe id="iframe_tei"></iframe>
        <div id="to_dot" class="button">tei to .dot</div>
      </div>
      <div id="demo_panel_003" class="demo_panel">
        <textarea id="dot"></textarea>
        <svg id="svg_graph"></svg>
        <div id="back_to_tei" class="button">back</div>
      </div>
    </div>
</body>
</html>
